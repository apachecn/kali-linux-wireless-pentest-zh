# 第七章 高级 WLAN 攻击

> 作者：Vivek Ramachandran, Cameron Buchanan

> 译者：[飞龙](https://github.com/)

> 协议：[CC BY-NC-SA 4.0](http://creativecommons.org/licenses/by-nc-sa/4.0/)

## 简介

> 知己知彼，百战不殆。

> 孙子，《孙子兵法》

作为渗透测试者，了解黑客可以执行的高阶攻击十分重要，即使你可能不会在渗透测试中执行它们。这一章致力于展示黑客如何能够将无线访问用作接入点，执行高级攻击。

这一章中，我们会看到我们如何能够使用所学的知识来执行高级攻击。我们基本上专注于中间人攻击（MITM），它的成功需要大量的技巧和实战。一旦我们完成了它，我们会使用这个 MITM 攻击作为更加复杂的攻击的基础，例如窃听和会话劫持。

## 7.1 中间人攻击

MITM 攻击可能是 WLAN 系统上最有潜力的攻击之一了。实施攻击可以使用不同的配置，我们会使用最普遍的一个 -- 攻击者使用有线 LAN 连接到互联网，并在客户端的网卡上创建了假的接入点。这个接入点广播的 SSID 和附近的本地热点相似。用户可能碰巧连接到这个假的接入点（或者由于更高的信号强度理论强制连接，我们之前讨论过），并且可能仍旧相信它连接到正常的接入点上。

攻击者现在可以将所有用户流量转发到互联网上，使用它所创建的有线和无线之间的网桥。

在下面的练习中，我们会模拟这个攻击。

### 实战时间 -- 中间人攻击

遵循以下指南来开始：

1.  为了开始中间人攻击，我们首先使用` airbase-ng`，在黑客的笔记本上创建软接入点，叫做`mitm`。我们执行下列命令：

    ```
    airbase-ng --essid mitm Cc 11 mon0
    ```
    
    命令输出如下：
    
    ![](img/7-1-1.jpg)
    
2.  要注意` airbase-ng`在运行的时候会创建接口`at0`。把它当做我们基于软件的接入点`mitm`的有线端的接口。

    ![](img/7-1-2.jpg)
    
3.  让我们现在在黑客的笔记本上创建网桥，由有线（`eth0`）和无线（`at0`）接口组成。命令如下：

    ```
    brctl addbr mitm-bridge 
    brctl addif mitm-bridge eth0 
    brctl addif mitm-bridge at0 
    ifconfig eth0 0.0.0.0 up 
    ifconfig at0 0.0.0.0 up
    ```
    
    ![](img/7-1-3.jpg)

4.  我们可以为这个网桥指定一个 IP 地址，并检查网关的连接性。要注意我们也可以使用 DHCP 来实现。我们可以为网桥接口指定 IP 地址，使用下列命令：

    ```
    ifconfig mitm-bridge 192.168.0.199 up
    ```
    
    我们之后尝试 ping 网关` 192.168.0.1`，来确保我们连接到了网络的剩余部分。
    
5.  我们现在开启内核的 IP 转发，便于封包能够正确转发，使用下列命令：

    ```
    echo 1 > /proc/sys/net/ipv4/ip_forward
    ```
    
    命令输出如下：
    
    ![](img/7-1-4.jpg)
    
6.  现在让我们将无线客户端连接到我们的接入点`mitm`上。它会通过 DHCP 自动获得 IP 地址（服务器运行在有线端的网关上）。这里，客户端主机的 IP 为`192.168.0.197`。我们可以 ping 有线端的网关`192.168.0.1`来验证连接性。

    ![](img/7-1-5.jpg)
    
7.  我们可以看到，主机响应了 ping 请求，像这样：

    ![](img/7-1-6.jpg)
    
8.  我们也可以验证客户端的连接，通过观察黑客主机上的`airbase-ng `终端：

    ![](img/7-1-7.jpg)
    
9.  这里提一句，非常有趣的是，由于所有流量都从无线接口转发到有线端，我们拥有流量的完整控制。我们可以通过启动 Wireshark 并嗅探`at0`接口来验证。

    ![](img/7-1-8.jpg)
    
0.  让我们现在从客户端主机上 ping 网关`192.168.0.1 `。我们可以看到， Wireshark 中的封包（使用过滤器 ICMP），即使封包的目标并不是我们。这就是中间人攻击的力量。

    ![](img/7-1-9.jpg)
    
### 刚刚发生了什么？

我们成功执行了中间人攻击的准备工作。我们通过创建伪造接入点并将其桥接到我们的以太网接口上。这确保了任何连接到伪造接入点的无线客户端会感觉到，它通过有线 LAN 连接到互联网。

### 试一试 -- 纯无线网络上的中间人攻击

在上一个练习中，我们桥接了无线和有线接口。我们之前提到过，这只是 MITM 的连接结构之一，也有其它的组合。我们可以使用两个无线接口，一个用于创建伪造的接入点，另一个接口连接到授权接入点。这两个接口都桥接在一起。所以，当无线客户端连接到我们的伪造接入点的时候，它就通过攻击者的主机连接到了授权接入点上。

要注意，这个配置需要使用攻击者笔记本上的两个网卡。

看看是否能够使用笔记本的内建网卡和外部网卡来执行这个攻击 -- 记住，你可能没有这个练习所需的注入驱动器。这是个很大的挑战。

## 7.2 通过 MITM 进行无线窃听

在上一个练习中，我们了解了如何为 MITM 进行准备。现在，我们会看一看如何使用它来进行无线窃听。

整个实验围绕一个原则，所有受害者的流量现在都经过攻击者的主机。所以，攻击者可以窃听任何发送并来自受害者主机的无线流量。

### 实战时间 -- 无线窃听

遵循以下指南来开始：

1.  重复上一个实验的所有步骤。启动 Wireshark，有趣的是，即使 MITM 桥接已经建立，这个跟接口仍然允许我们窥视桥接的流量，如果我们想要的话：

    ![](img/7-2-1.jpg)
    
2.  启动`at0`接口上的嗅探，便于我们监控所有由无线网卡发送和接收的流量：

    ![](img/7-2-2.jpg)
    
3.  在无线客户端，打开任何网页。我这里，无线接入点也连接到 LAN 上，我们使用地址`http://192.168.0.1`来打开它：

    ![](img/7-2-3.jpg)
    
4.  使用你的密码登录，进入管理界面。

5，  在 Wireshark 中，我们应该看到了大量活动：

    ![](img/7-2-4.jpg)
    
6.  设置过滤器 HTTP 来只查看 Web 流量：

    ![](img/7-2-5.jpg)
    
7.  我们可以轻易定位用于向接入点发送密码的 HTTP POST 请求。

    ![](img/7-2-6.jpg)

8.  下面是之前封包的详细视图。

    ![](img/7-2-7.jpg)
    
9.  展开 HTTP 协议头，我们会看到我们所输入的密码并没有以纯文本发送，反之它发送了哈希值。如果我们看一看封包，在上一个截图中标号为 64，我们可以看到，有一个`/md5.js`的请求，这使我们怀疑它是密码的 MD5 哈希值。有趣的是，在哈希的创建中，如果没有在每个会话层面加盐，这个技巧容易受到重放攻击。我们将其留做一个练习来发现细节，因为这并不是无线安全的一部分，从而超出了这本书的内容。

    ![](img/7-2-8.jpg)
    
0.  这展示了在中间人攻击期间，监视器如何轻易窃听由客户端发送的流量。

### 刚刚发生了什么？

我们准备的 MITM 环境现在允许我们窃听受害者的无线流量，而无需让受害者知道。这是因为在 MITM 中，所有流量都经过攻击者的主机。所以，所有受害者的未加密流量都可被攻击者窃听。

### 试一试 -- 发现 Google 搜索者

在当今世界，我们都任何我们在 Google 上的搜索都是私密的。很不幸，Google 搜索上的流量都经过 HTTP，并且默认是纯文本。

你可以想出一个智能的过滤器，使你能够使用 Wireshark 来查看受害者所执行的所有 Google 搜索吗？
